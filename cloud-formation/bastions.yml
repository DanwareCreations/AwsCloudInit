AWSTemplateFormatVersion: 2010-09-09

Description: Requested number of bastion hosts, each in their own public subnet and termination-protected

Parameters:
  NumberOfAZs:
    Type: Number
    Default: 2
    AllowedValues: [ 1, 2, 3, 4 ]
    Description: The number of Availability Zones in the current region.  Too high a number will cause a stack creation failure.  Too low a number will just leave some AZs without a bastion.  Note that you will be billed for every created bastion.
  HardenOS:
    Type: String
    Default: true
    AllowedValues: [ true, false]
    Description: Hardened bastion hosts will use the latest CIS AMI to improve security.  Unhardened hosts will use the latest Amazon Linux AMI.
  KeyPair:
    Type: AWS::EC2::KeyPair::KeyName
    Description: The EC2 key pair needed to connect to all new bastion hosts.
  NetworkStackName:
    Type: String
    Default : MainVPC
    MinLength : 1
    MaxLength : 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Description: Name of an active CloudFormation stack that contains the networking resources needed to create a bastion host in its own public subnet.
    ConstraintDescription: must contain only alphanumeric characters and/or hyphens, and start with a letter
  
Conditions:
  AtLeast4: !Equals [ !Ref NumberOfAZs, 4 ]
  AtLeast3: !Or [!Equals [!Ref NumberOfAZs, 3], Condition: AtLeast4]
  AtLeast2: !Or [!Equals [!Ref NumberOfAZs, 2], Condition: AtLeast3]
  AtLeast1: !Or [!Equals [!Ref NumberOfAZs, 1], Condition: AtLeast2]
  Harden: !Equals [ !Ref HardenOS, true]
  
Mappings:
  AzMap:
    us-east-1:          # N. Virginia
      "1": us-east-1a
      "2": us-east-1b
      "3": us-east-1c
      "4": us-east-1e
    us-east-2:          # Ohio
      "1": us-east-2a
      "2": us-east-2b
      "3": us-east-2c
    us-west-1:          # N. California
      "1": us-west-1a
      "2": us-west-1c
    us-west-2:          # Oregon
      "1": us-west-2a
      "2": us-west-2b
      "3": us-west-2c
    eu-west-1:          # Ireland
      "1": eu-west-1a
      "2": eu-west-1b
      "3": eu-west-1c
    eu-central-1:       # Frankfurt
      "1": eu-central-1a
      "2": eu-central-1b
    ap-northeast-1:     # Tokyo
      "1": ap-northeast-1a
      "2": ap-northeast-1c
    ap-northeast-2:     # Seoul
      "1": ap-northeast-2a
      "2": ap-northeast-2c
    ap-southeast-1:     # Singapore
      "1": ap-southeast-1a
      "2": ap-southeast-1b
    ap-southeast-2:     # Sydney
      "1": ap-southeast-2a
      "2": ap-southeast-2b
      "3": ap-southeast-2c
    ap-south-1:         # Mumbai
      "1": ap-south-1a
      "2": ap-south-1b
    sa-east-1:          # Sao Paulo
      "1": sa-east-1a
      "2": sa-east-1c
  CidrMap:
    AZ:
      "1": 10.0.128.0/24
      "2": 10.0.129.0/24
      "3": 10.0.130.0/24
      "4": 10.0.131.0/24
  AmiMap:
    us-east-1:
      harden:     ami-4d5c0a28
      dontHarden: ami-b73b63a0
    us-east-2:
      harden:     ami-71ca9114      # CIS AMI not supported in Ohio
      dontHarden: ami-58277d3d
    us-west-1:
      harden:     ami-4104c405
      dontHarden: ami-23e8a343
    us-west-2:
      harden:     ami-34866607
      dontHarden: ami-5ec1673e
    eu-west-1:
      harden:     ami-2fd5e758
      dontHarden: ami-9398d3e0
    eu-central-1:
      harden:     ami-5254584f
      dontHarden: ami-f9619996
    ap-northeast-1:
      harden:     ami-8c0d6d8c
      dontHarden: ami-0c11b26d
    ap-northeast-2:
      harden:     ami-839b55ed
      dontHarden: ami-983ce8f6
    ap-southeast-1:
      harden:     ami-5c91810e
      dontHarden: ami-b953f2da
    ap-southeast-2:
      harden:     ami-e1f1badb
      dontHarden: ami-db704cb8
    ap-south-1:
      harden:     ami-cacbbea5     # CIS AMI not supported in Mumbai
      dontHarden: ami-34b4c05b
    sa-east-1:
      harden:     ami-45e77658
      dontHarden: ami-97831ffb
  StringsMap:
    UserData:
      bash: |
        #!/bin/bash
        
        # Add a newline to the ec2-user prompt string
        echo PS1="\"\\n\$PS1\"">> /home/ec2-user/.bashrc

        # Update all packages
        echo
        echo Updating all YUM packages...
        yum update -y > NUL
  
Resources:
  # Route Table for the new public subnet(s)
  PubRT:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !ImportValue MainVPC
  InternetRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !ImportValue MainIGW
      RouteTableId: !Ref PubRT
  
  # Network ACL for the new public subnet(s)
  PubACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !ImportValue MainVPC
  InEphemeraAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 130
      Egress: false
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 1024, To: 65535 }
      CidrBlock: 0.0.0.0/0
  InIcmpAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 140
      Egress: false
      RuleAction: allow
      Protocol: 1
      Icmp: { Code: -1, Type: -1 }
      CidrBlock: 0.0.0.0/0
  InHttpAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 100
      Egress: false
      RuleAction: allow
      Protocol: 6
      CidrBlock: 0.0.0.0/0
      PortRange: { From: 80, To: 80 }
  InSshAcl1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 120
      Egress: false
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 22, To: 22 }
      CidrBlock: 107.218.90.121/32
  InSshAcl2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 121
      Egress: false
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 22, To: 22 }
      CidrBlock: 130.101.99.0/24
  InSshAcl3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 122
      Egress: false
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 22, To: 22 }
      CidrBlock: 10.0.128.0/17

  OutEphemeraAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 130
      Egress: true
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 1024, To: 65535 }
      CidrBlock: 0.0.0.0/0
  OutIcmpAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 140
      Egress: true
      RuleAction: allow
      Protocol: 1
      Icmp: { Code: -1, Type: -1 }
      CidrBlock: 0.0.0.0/0
  OutSshAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 120
      Egress: true
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 22, To: 22 }
      CidrBlock: 10.0.0.0/16
  OutHttpAcl:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PubACL
      RuleNumber: 100
      Egress: true
      RuleAction: allow
      Protocol: 6
      PortRange: { From: 80, To: 80 }
      CidrBlock: 0.0.0.0/0
  
  # Define the requested number of subnets
  Subnet1:
    Type: AWS::EC2::Subnet
    Condition: AtLeast1
    Properties:
      VpcId: !ImportValue MainVPC
      AvailabilityZone: !FindInMap [AzMap, !Ref "AWS::Region", 1]
      CidrBlock: !FindInMap [CidrMap, AZ, 1]
      MapPublicIpOnLaunch: true
  RTAssoc1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: AtLeast1
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Subnet1
  ACLAssoc1:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Condition: AtLeast1
    Properties:
      NetworkAclId: !Ref PubACL
      SubnetId: !Ref Subnet1
      
  Subnet2:
    Type: AWS::EC2::Subnet
    Condition: AtLeast2
    Properties:
      VpcId: !ImportValue MainVPC
      AvailabilityZone: !FindInMap [AzMap, !Ref "AWS::Region", 2]
      CidrBlock: !FindInMap [CidrMap, AZ, 2]
      MapPublicIpOnLaunch: true
  RTAssoc2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: AtLeast2
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Subnet2
  ACLAssoc2:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Condition: AtLeast2
    Properties:
      NetworkAclId: !Ref PubACL
      SubnetId: !Ref Subnet2
      
  Subnet3:
    Type: AWS::EC2::Subnet
    Condition: AtLeast3
    Properties:
      VpcId: !ImportValue MainVPC
      AvailabilityZone: !FindInMap [AzMap, !Ref "AWS::Region", 3]
      CidrBlock: !FindInMap [CidrMap, AZ, 3]
      MapPublicIpOnLaunch: true
  RTAssoc3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: AtLeast3
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Subnet3
  ACLAssoc3:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Condition: AtLeast3
    Properties:
      NetworkAclId: !Ref PubACL
      SubnetId: !Ref Subnet3
      
  Subnet4:
    Type: AWS::EC2::Subnet
    Condition: AtLeast4
    Properties:
      VpcId: !ImportValue MainVPC
      AvailabilityZone: !FindInMap [AzMap, !Ref "AWS::Region", 4]
      CidrBlock: !FindInMap [CidrMap, AZ, 4]
      MapPublicIpOnLaunch: true
  RTAssoc4:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: AtLeast4
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Subnet4
  ACLAssoc4:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Condition: AtLeast4
    Properties:
      NetworkAclId: !Ref PubACL
      SubnetId: !Ref Subnet4
  
  # Security Group for the bastion hosts
  BastionSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !ImportValue MainVPC
      GroupDescription: Allow SSH access from authorized computers, and SSH access to private subnets
      SecurityGroupIngress:
      - # ICMP traffic from anywhere
        IpProtocol: icmp
        FromPort: -1
        ToPort: -1
        CidrIp: 0.0.0.0/0
      - # SSH from Vicarel home
        IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 107.218.90.0/24
      - # SSH from Renna lab
        IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 130.101.99.0/24
      - # SSH from public subnets
        IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 10.0.128.0/17
      SecurityGroupEgress:
      - # SSH into private subnets
        IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 10.0.0.0/16
      - # HTTP for automatic updates
        IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
  IngressFromSameSgRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt BastionSG.GroupId
      IpProtocol: -1
      SourceSecurityGroupId: !GetAtt BastionSG.GroupId
  EgressToSameSgRule:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !GetAtt BastionSG.GroupId
      IpProtocol: -1
      SourceSecurityGroupId: !GetAtt BastionSG.GroupId
  
          
  # Define the EC2 instance(s)
  Bastion1:
    Type: AWS::EC2::Instance
    Condition: AtLeast1
    Properties:
      DisableApiTermination: true
      EbsOptimized: false
      ImageId: !If [Harden, !FindInMap [AmiMap, !Ref "AWS::Region", harden], !FindInMap [AmiMap, !Ref "AWS::Region", dontHarden] ]
      InstanceInitiatedShutdownBehavior: stop
      InstanceType: !If [Harden, t2.micro, t2.nano]
      KeyName: !Ref KeyPair
      Monitoring: true
      NetworkInterfaces:
      - DeviceIndex: 0
        AssociatePublicIpAddress: true
        DeleteOnTermination: true
        GroupSet: [ !Ref BastionSG ]
        SubnetId: !Ref Subnet1
        Description: Network interface for a bastion host
      SourceDestCheck: true
      Tenancy: default
      UserData:
        Fn::Base64: !FindInMap [ StringsMap, UserData, bash ]
  Bastion2:
    Type: AWS::EC2::Instance
    Condition: AtLeast2
    Properties:
      DisableApiTermination: true
      EbsOptimized: false
      ImageId: !If [Harden, !FindInMap [AmiMap, !Ref "AWS::Region", harden], !FindInMap [AmiMap, !Ref "AWS::Region", dontHarden] ]
      InstanceInitiatedShutdownBehavior: stop
      InstanceType: !If [Harden, t2.micro, t2.nano]
      KeyName: !Ref KeyPair
      Monitoring: true
      NetworkInterfaces:
      - DeviceIndex: 0
        AssociatePublicIpAddress: true
        DeleteOnTermination: true
        GroupSet: [ !Ref BastionSG ]
        SubnetId: !Ref Subnet2
        Description: Network interface for a bastion host
      SourceDestCheck: true
      Tenancy: default
      UserData:
        Fn::Base64: !FindInMap [ StringsMap, UserData, bash ]
  Bastion3:
    Type: AWS::EC2::Instance
    Condition: AtLeast3
    Properties:
      DisableApiTermination: true
      EbsOptimized: false
      ImageId: !If [Harden, !FindInMap [AmiMap, !Ref "AWS::Region", harden], !FindInMap [AmiMap, !Ref "AWS::Region", dontHarden] ]
      InstanceInitiatedShutdownBehavior: stop
      InstanceType: !If [Harden, t2.micro, t2.nano]
      KeyName: !Ref KeyPair
      Monitoring: true
      NetworkInterfaces:
      - DeviceIndex: 0
        AssociatePublicIpAddress: true
        DeleteOnTermination: true
        GroupSet: [ !Ref BastionSG ]
        SubnetId: !Ref Subnet3
        Description: Network interface for a bastion host
      SourceDestCheck: true
      Tenancy: default
      UserData:
        Fn::Base64: !FindInMap [ StringsMap, UserData, bash ]
  Bastion4:
    Type: AWS::EC2::Instance
    Condition: AtLeast4
    Properties:
      DisableApiTermination: true
      EbsOptimized: false
      ImageId: !If [Harden, !FindInMap [AmiMap, !Ref "AWS::Region", harden], !FindInMap [AmiMap, !Ref "AWS::Region", dontHarden] ]
      InstanceInitiatedShutdownBehavior: stop
      InstanceType: !If [Harden, t2.micro, t2.nano]
      KeyName: !Ref KeyPair
      Monitoring: true
      NetworkInterfaces:
      - DeviceIndex: 0
        AssociatePublicIpAddress: true
        DeleteOnTermination: true
        GroupSet: [ !Ref BastionSG ]
        SubnetId: !Ref Subnet4
        Description: Network interface for a bastion host
      SourceDestCheck: true
      Tenancy: default
      UserData:
        Fn::Base64: !FindInMap [ StringsMap, UserData, bash ]
Outputs:
  Bastion1:
    Value: !GetAtt Bastion1.PublicIp
    Condition: AtLeast1
    Description: The public IP address of the new bastion host
  Bastion2:
    Value: !GetAtt Bastion2.PublicIp
    Condition: AtLeast2
    Description: The public IP address of the new bastion host
  Bastion3:
    Value: !GetAtt Bastion3.PublicIp
    Condition: AtLeast3
    Description: The public IP address of the new bastion host
  Bastion4:
    Value: !GetAtt Bastion4.PublicIp
    Condition: AtLeast4
    Description: The public IP address of the new bastion host
  